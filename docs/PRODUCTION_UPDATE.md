# SsalgTen ç”Ÿäº§ç¯å¢ƒæ›´æ–°ç³»ç»Ÿ

## æ¦‚è¿°

SsalgTen å†…ç½®äº†å…ˆè¿›çš„é›¶åœæœºæ›´æ–°ç³»ç»Ÿï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®‰å…¨åœ°è¿›è¡Œè‡ªåŠ¨åŒ–æ›´æ–°ï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’ŒæœåŠ¡è¿ç»­æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **é›¶åœæœºæ›´æ–°** - æœåŠ¡ä»…çŸ­æš‚ä¸­æ–­ï¼ˆé€šå¸¸ < 30 ç§’ï¼‰
- ğŸ”’ **è‡ªåŠ¨æ•°æ®å¤‡ä»½** - æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“å’Œé…ç½®
- ğŸ¥ **å¥åº·æ£€æŸ¥éªŒè¯** - ç¡®ä¿æ›´æ–°åç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- ğŸ”„ **å¤±è´¥è‡ªåŠ¨å›æ»š** - å‡ºé”™æ—¶è‡ªåŠ¨å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬
- ğŸ“Š **å®æ—¶æ›´æ–°æ—¥å¿—** - Webç•Œé¢å®æ—¶æ˜¾ç¤ºæ›´æ–°è¿›åº¦
- ğŸ›¡ï¸ **æƒé™æ§åˆ¶** - ä»…ç®¡ç†å‘˜å¯æ‰§è¡Œç³»ç»Ÿæ›´æ–°

## æ¶æ„åŸç†

```
ç”¨æˆ·ç‚¹å‡»"ç«‹å³æ›´æ–°" 
    â†“
åç«¯APIæ¥æ”¶è¯·æ±‚
    â†“
è°ƒç”¨UpdateræœåŠ¡
    â†“
UpdateræœåŠ¡æ‰§è¡Œæ›´æ–°è„šæœ¬
    â†“
1. åˆ›å»ºæ•°æ®å¤‡ä»½
2. æ‹‰å–æœ€æ–°ä»£ç   
3. é‡å»ºDockeré•œåƒ
4. æ»šåŠ¨æ›´æ–°å®¹å™¨
5. å¥åº·æ£€æŸ¥éªŒè¯
    â†“
æ›´æ–°å®Œæˆï¼Œè¿”å›ç»“æœ
```

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

### 1. å‰ç½®è¦æ±‚

ç¡®ä¿ä½ çš„ç”Ÿäº§æœåŠ¡å™¨æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

```bash
# ç³»ç»Ÿè¦æ±‚
- Docker 20.10+
- Docker Compose 2.0+
- Git 2.20+
- è‡³å°‘ 2GB å¯ç”¨å†…å­˜
- è‡³å°‘ 5GB å¯ç”¨ç£ç›˜ç©ºé—´

# ç½‘ç»œè¦æ±‚
- èƒ½å¤Ÿè®¿é—® GitHub API (api.github.com)
- Docker Hub æˆ–ç§æœ‰é•œåƒä»“åº“è®¿é—®æƒé™
```

### 2. åˆå§‹éƒ¨ç½²

#### æ­¥éª¤ 1ï¼šå…‹éš†ä»£ç åˆ°ç”Ÿäº§æœåŠ¡å™¨

```bash
# å…‹éš†åˆ°ç”Ÿäº§ç›®å½•
git clone https://github.com/lonelyrower/SsalgTen.git /opt/ssalgten
cd /opt/ssalgten

# åˆ‡æ¢åˆ°ç¨³å®šåˆ†æ”¯
git checkout main
```

#### æ­¥éª¤ 2ï¼šé…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶å¹¶ç¼–è¾‘ç¯å¢ƒé…ç½®
cp .env.example .env
nano .env

# é‡è¦ï¼šè®¾ç½®ä»¥ä¸‹ç”Ÿäº§ç¯å¢ƒå˜é‡
UPDATER_TOKEN=your-super-secure-updater-token-here-change-this
JWT_SECRET=your-production-jwt-secret-key-must-be-strong
API_KEY_SECRET=your-production-api-key-secret
DB_PASSWORD=your-strong-database-password
REDIS_PASSWORD=your-strong-redis-password

# GitHubç›¸å…³ï¼ˆç”¨äºç‰ˆæœ¬æ£€æŸ¥ï¼‰
REPO_OWNER=lonelyrower
REPO_NAME=SsalgTen  
REPO_BRANCH=main
GITHUB_TOKEN=your-github-token-optional-for-rate-limits
```

#### æ­¥éª¤ 3ï¼šå¯åŠ¨ç³»ç»Ÿ

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬Updaterï¼‰
docker-compose up -d

# éªŒè¯æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ
docker-compose ps
```

#### æ­¥éª¤ 4ï¼šéªŒè¯æ›´æ–°åŠŸèƒ½

```bash
# æ£€æŸ¥UpdateræœåŠ¡çŠ¶æ€
curl http://localhost:8765/health

# åº”è¯¥è¿”å›: {"ok":true}
```

### 3. ä½¿ç”¨æ›´æ–°åŠŸèƒ½

#### Webç•Œé¢æ“ä½œ

1. ç™»å½•ç³»ç»Ÿç®¡ç†ç•Œé¢
2. è®¿é—® "ç³»ç»Ÿç®¡ç†" â†’ "ç³»ç»Ÿæ¦‚è§ˆ"
3. æŸ¥çœ‹"ç³»ç»Ÿæ›´æ–°"å¡ç‰‡
4. ç‚¹å‡»"æ£€æŸ¥å¹¶æ›´æ–°"æˆ–"ç«‹å³æ›´æ–°"æŒ‰é’®
5. ç¡®è®¤æ›´æ–°å¯¹è¯æ¡†
6. å®æ—¶æŸ¥çœ‹æ›´æ–°æ—¥å¿—
7. ç­‰å¾…æ›´æ–°å®Œæˆ

#### å‘½ä»¤è¡Œæ“ä½œï¼ˆå¯é€‰ï¼‰

```bash
# æ‰‹åŠ¨è§¦å‘æ›´æ–°
curl -X POST http://localhost:8765/update \
  -H "X-Updater-Token: your-updater-token" \
  -H "Content-Type: application/json" \
  -d '{"async": true}'

# æŸ¥çœ‹æ›´æ–°æ—¥å¿—
curl http://localhost:8765/jobs/[job-id]
```

### 4. æ›´æ–°æµç¨‹è¯¦è§£

#### é˜¶æ®µ 1ï¼šå‡†å¤‡å’Œå¤‡ä»½ï¼ˆ1-2åˆ†é’Ÿï¼‰
```
âœ… æ›´æ–°ä»»åŠ¡å·²å¯åŠ¨
ğŸ” æ£€æŸ¥å½“å‰è¿è¡ŒçŠ¶æ€...
ğŸ’¾ å¼€å§‹åˆ›å»ºæ•°æ®å¤‡ä»½...
â”œâ”€ å¤‡ä»½æ•°æ®åº“...
â”œâ”€ å¤‡ä»½é…ç½®æ–‡ä»¶...
â””â”€ å¤‡ä»½Dockerå·æ•°æ®...
âœ… æ•°æ®å¤‡ä»½å®Œæˆ
```

#### é˜¶æ®µ 2ï¼šä»£ç æ›´æ–°ï¼ˆ30ç§’-1åˆ†é’Ÿï¼‰
```
ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ...
ğŸ“ æœ¬æ¬¡æ›´æ–°åŒ…å«çš„æ›´æ”¹:
â”œâ”€ abc1234 Fix bug in monitoring system
â”œâ”€ def5678 Update security dependencies  
â””â”€ ghi9012 Improve update system reliability
```

#### é˜¶æ®µ 3ï¼šæœåŠ¡æ›´æ–°ï¼ˆ1-2åˆ†é’Ÿï¼‰
```
ğŸ”„ å¼€å§‹æ»šåŠ¨æ›´æ–°...
â”œâ”€ æ›´æ–°åç«¯æœåŠ¡...
â”œâ”€ æ›´æ–°å‰ç«¯æœåŠ¡...
â””â”€ æ›´æ–°ä»£ç†æœåŠ¡...
ğŸ¥ æ‰§è¡Œæœ€ç»ˆå¥åº·æ£€æŸ¥...
âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡
âœ… å‰ç«¯å¥åº·æ£€æŸ¥é€šè¿‡
```

#### é˜¶æ®µ 4ï¼šå®Œæˆæ¸…ç†ï¼ˆ30ç§’ï¼‰
```
ğŸ§¹ æ¸…ç†æ—§çš„Dockeré•œåƒ...
ğŸ“Š æ›´æ–°æ‘˜è¦:
â”œâ”€ æ–°ç‰ˆæœ¬: abc1234
â”œâ”€ å¤‡ä»½è·¯å¾„: .update/backups/backup_20231201_143022
â””â”€ æ—¥å¿—æ–‡ä»¶: .update/logs/update_20231201_143022.log
ğŸ‰ ç³»ç»Ÿæ›´æ–°æˆåŠŸå®Œæˆï¼ŒæœåŠ¡æ­£å¸¸è¿è¡Œï¼
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. è®¿é—®æ§åˆ¶

```bash
# ç¡®ä¿åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ›´æ–°åŠŸèƒ½
# åœ¨é˜²ç«å¢™ä¸­é™åˆ¶8765ç«¯å£è®¿é—®ï¼ˆå¯é€‰ï¼‰
iptables -A INPUT -p tcp --dport 8765 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 8765 -j DROP

# ä½¿ç”¨å¼ºå¯†ç ä½œä¸ºUPDATER_TOKEN
UPDATER_TOKEN=$(openssl rand -base64 32)
```

### 2. æ•°æ®ä¿æŠ¤

```bash
# å®šæœŸæ£€æŸ¥å¤‡ä»½æ–‡ä»¶
ls -la .update/backups/

# è®¾ç½®å¤‡ä»½æ¸…ç†è®¡åˆ’ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find .update/backups/ -name "backup_*" -mtime +30 -delete
```

### 3. ç›‘æ§å»ºè®®

```bash
# ç›‘æ§æ›´æ–°æ—¥å¿—
tail -f .update/logs/update_*.log

# ç›‘æ§ç£ç›˜ç©ºé—´ï¼ˆå¤‡ä»½ä¼šå ç”¨ç©ºé—´ï¼‰
df -h

# ç›‘æ§Dockerèµ„æºä½¿ç”¨
docker stats
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ›´æ–°å¤±è´¥ï¼šUpdateræœåŠ¡æ— æ³•è®¿é—®

**ç—‡çŠ¶ï¼š**
```
âŒ æ›´æ–°å¯åŠ¨å¤±è´¥: Updater service not reachable
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥UpdateræœåŠ¡çŠ¶æ€
docker-compose ps updater
docker-compose logs updater

# é‡å¯UpdateræœåŠ¡
docker-compose restart updater
```

#### 2. æ›´æ–°å¤±è´¥ï¼šGitæƒé™é—®é¢˜

**ç—‡çŠ¶ï¼š**
```
ERROR Gitæ‹‰å–å¤±è´¥
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥Gité…ç½®
cd /opt/ssalgten
git remote -v
git status

# é‡ç½®åˆ°è¿œç¨‹åˆ†æ”¯
git fetch origin
git reset --hard origin/main
```

#### 3. æ›´æ–°å¤±è´¥ï¼šDockerèµ„æºä¸è¶³

**ç—‡çŠ¶ï¼š**
```
ERROR æœåŠ¡æ„å»ºå¤±è´¥
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç†Dockerèµ„æº
docker system prune -f
docker volume prune -f

# æ£€æŸ¥å¯ç”¨ç©ºé—´
df -h
docker system df
```

#### 4. æ›´æ–°åæœåŠ¡å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å›æ»šåŠŸèƒ½**

```bash
# æŸ¥çœ‹å¯ç”¨å¤‡ä»½
ls -la .update/backups/

# æ‰§è¡Œå›æ»šï¼ˆæ›¿æ¢ä¸ºå®é™…çš„å¤‡ä»½IDï¼‰
./scripts/rollback.sh 20231201_143022
```

### æ‰‹åŠ¨å›æ»š

å¦‚æœWebç•Œé¢æ— æ³•è®¿é—®ï¼Œå¯ä»¥æ‰‹åŠ¨å›æ»šï¼š

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/ssalgten

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
LATEST_BACKUP=$(ls -1t .update/backups/ | head -1)
echo "æœ€æ–°å¤‡ä»½: $LATEST_BACKUP"

# æ‰§è¡Œå›æ»š
./scripts/rollback.sh ${LATEST_BACKUP#backup_}

# éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose ps
curl http://localhost:3001/api/health
```

## é«˜çº§é…ç½®

### 1. è‡ªå®šä¹‰æ›´æ–°ç­–ç•¥

ç¼–è¾‘ `scripts/update-production.sh` æ¥è‡ªå®šä¹‰æ›´æ–°è¡Œä¸ºï¼š

```bash
# ä¿®æ”¹å¥åº·æ£€æŸ¥è¶…æ—¶
MAX_HEALTH_ATTEMPTS=20  # é»˜è®¤30æ¬¡

# ä¿®æ”¹å¤‡ä»½ä¿ç•™ç­–ç•¥  
BACKUP_RETENTION_DAYS=14  # é»˜è®¤30å¤©

# æ·»åŠ è‡ªå®šä¹‰æ£€æŸ¥
custom_health_check() {
    # ä½ çš„è‡ªå®šä¹‰å¥åº·æ£€æŸ¥é€»è¾‘
    return 0
}
```

### 2. é›†æˆå¤–éƒ¨ç›‘æ§

```bash
# Webhooké€šçŸ¥ï¼ˆå¯é€‰ï¼‰
WEBHOOK_URL="https://your-webhook-url.com/notifications"

# åœ¨æ›´æ–°è„šæœ¬ä¸­æ·»åŠ é€šçŸ¥
notify_webhook() {
    curl -X POST "$WEBHOOK_URL" \
         -H "Content-Type: application/json" \
         -d "{\"message\":\"$1\",\"status\":\"$2\"}"
}
```

### 3. å¤šç¯å¢ƒé…ç½®

```bash
# ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
cp .env .env.production
cp .env .env.staging

# ä½¿ç”¨ç¯å¢ƒç‰¹å®šé…ç½®
docker-compose --env-file .env.production up -d
```

## æœ€ä½³å®è·µ

### 1. æ›´æ–°å‰æ£€æŸ¥æ¸…å•

- [ ] ç¡®è®¤ç³»ç»Ÿè´Ÿè½½è¾ƒä½
- [ ] éªŒè¯ç£ç›˜ç©ºé—´å……è¶³ï¼ˆ> 5GBï¼‰
- [ ] æ£€æŸ¥å¤‡ä»½ç›®å½•å¯å†™
- [ ] é€šçŸ¥ç›¸å…³ç”¨æˆ·è®¡åˆ’æ›´æ–°æ—¶é—´

### 2. å®šæœŸç»´æŠ¤

```bash
# æ¯å‘¨æ¸…ç†è„šæœ¬
#!/bin/bash
# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘7ä¸ªï¼‰
cd /opt/ssalgten
find .update/backups/ -name "backup_*" -type d | sort -r | tail -n +8 | xargs rm -rf

# æ¸…ç†æ—§æ—¥å¿—ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
find .update/logs/ -name "*.log" -mtime +30 -delete

# æ¸…ç†Dockerèµ„æº
docker image prune -f
docker system prune -f
```

### 3. ç›‘æ§å»ºè®®

- è®¾ç½®ç£ç›˜ç©ºé—´ç›‘æ§å‘Šè­¦ï¼ˆ< 2GBï¼‰
- ç›‘æ§DockeræœåŠ¡å¥åº·çŠ¶æ€
- å®šæœŸæµ‹è¯•å›æ»šåŠŸèƒ½
- è®°å½•æ›´æ–°æ“ä½œæ—¥å¿—

---

## è”ç³»æ”¯æŒ

å¦‚é‡åˆ°æ›´æ–°ç›¸å…³é—®é¢˜ï¼š

1. æŸ¥çœ‹æ›´æ–°æ—¥å¿—ï¼š`.update/logs/`
2. æŸ¥çœ‹Dockeræ—¥å¿—ï¼š`docker-compose logs`
3. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ï¼š`docker-compose ps`
4. å°è¯•å›æ»šæ“ä½œï¼š`./scripts/rollback.sh`

**è®°ä½ï¼šæ›´æ–°åŠŸèƒ½è®¾è®¡ä¸ºå®‰å…¨ä¼˜å…ˆï¼Œé‡åˆ°é—®é¢˜æ—¶ä¼šè‡ªåŠ¨åœæ­¢å¹¶ä¿æŠ¤æ•°æ®å®Œæ•´æ€§ã€‚**