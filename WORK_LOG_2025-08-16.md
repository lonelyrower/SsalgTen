# SsalgTen é¡¹ç›®å·¥ä½œæ—¥å¿— - 2025å¹´8æœˆ16æ—¥

## ğŸ“‹ å·¥ä½œæ¦‚è§ˆ

**æ—¥æœŸ**: 2025å¹´8æœˆ16æ—¥  
**ä¸»è¦ä»»åŠ¡**: é¡¹ç›®å®Œæ•´æµ‹è¯•ã€VPSéƒ¨ç½²é—®é¢˜ä¿®å¤ã€AgentèŠ‚ç‚¹éƒ¨ç½²æŒ‡å¯¼  
**å‚ä¸è€…**: Claude (AIåŠ©æ‰‹) + ç”¨æˆ·  

## ğŸ”§ æ ¸å¿ƒå·¥ä½œå†…å®¹

### 1. é¡¹ç›®å®Œæ•´æµ‹è¯•ä¸éªŒè¯
**æ—¶é—´æ®µ**: ä¸Šåˆ - ä¸­åˆ  
**çŠ¶æ€**: âœ… å®Œæˆ

#### æ‰§è¡Œçš„æµ‹è¯•é¡¹ç›®:
- **ç¯å¢ƒæ¸…ç†**: å®Œå…¨æ¸…ç†Dockerç¯å¢ƒï¼Œé‡æ–°æ„å»ºæ‰€æœ‰å®¹å™¨
- **æ•°æ®åº“æµ‹è¯•**: PostgreSQLè¿æ¥ã€è¿ç§»ã€ç§å­æ•°æ®åˆ›å»º
- **åç«¯APIæµ‹è¯•**: 
  - å¥åº·æ£€æŸ¥: `/api/health` âœ…
  - ä¿¡æ¯æ¥å£: `/api/info` âœ…  
  - èŠ‚ç‚¹ç®¡ç†: `/api/nodes` âœ…
  - ç»Ÿè®¡ä¿¡æ¯: `/api/stats` âœ…
  - ç”¨æˆ·è®¤è¯: `/api/auth/login` âœ…
- **å‰ç«¯åº”ç”¨æµ‹è¯•**: 
  - ä¸»é¡µè®¿é—® âœ…
  - é…ç½®æ–‡ä»¶ç”Ÿæˆ âœ…
  - Nginxä»£ç† âœ…
- **å®¹å™¨é—´é€šä¿¡æµ‹è¯•**: ç½‘ç»œè¿é€šæ€§éªŒè¯ âœ…
- **å¥åº·æ£€æŸ¥æµ‹è¯•**: æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€éªŒè¯ âœ…

#### æµ‹è¯•ç»“æœ:
- âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ (ç®¡ç†å‘˜: admin/admin123)
- âœ… å®¹å™¨é—´ç½‘ç»œé€šä¿¡æ­£å¸¸
- âš ï¸ å‰ç«¯å¥åº·æ£€æŸ¥æ˜¾ç¤ºunhealthy (IPv6é—®é¢˜ï¼ŒåŠŸèƒ½æ­£å¸¸)

### 2. VPSéƒ¨ç½²é—®é¢˜è¯Šæ–­ä¸ä¿®å¤
**æ—¶é—´æ®µ**: ä¸­åˆ - ä¸‹åˆ  
**çŠ¶æ€**: âœ… å®Œæˆ

#### å‘ç°çš„å…³é”®é—®é¢˜:
1. **åç«¯å®¹å™¨å¯åŠ¨å¤±è´¥** - `docker-start.sh`è„šæœ¬ä¸­Prismaæ–¹æ³•è°ƒç”¨è¯­æ³•é”™è¯¯
   - é—®é¢˜: `p.$queryRawUnsafe` å’Œ `p.$disconnect` åœ¨shellä¸­éœ€è¦è½¬ä¹‰
   - ä¿®å¤: æ·»åŠ åæ–œæ è½¬ä¹‰ `p.\$queryRawUnsafe` å’Œ `p.\$disconnect`

2. **å‰ç«¯å®¹å™¨å…¥å£ç‚¹é…ç½®è¿‡äºå¤æ‚**
   - é—®é¢˜: è‡ªå®šä¹‰å…¥å£è„šæœ¬è·¯å¾„å¤„ç†é”™è¯¯
   - ä¿®å¤: ç®€åŒ–Dockerfile.frontendï¼Œä½¿ç”¨æ ‡å‡†nginxå…¥å£ç‚¹

#### ä»£ç ä¿®å¤è¯¦æƒ…:
**æ–‡ä»¶**: `backend/docker-start.sh`
```bash
# ä¿®å¤å‰ (ç¬¬20è¡Œ):
until node -e "const {PrismaClient}=require('@prisma/client');(async()=>{try{const p=new PrismaClient();await p.$queryRawUnsafe('SELECT 1');await p.$disconnect();process.exit(0);}catch(e){console.error('DB wait attempt error:',e.message);process.exit(1);}})();"; do

# ä¿®å¤å:
until node -e "const {PrismaClient}=require('@prisma/client');(async()=>{try{const p=new PrismaClient();await p.\$queryRawUnsafe('SELECT 1');await p.\$disconnect();process.exit(0);}catch(e){console.error('DB wait attempt error:',e.message);process.exit(1);}})();"; do
```

**æ–‡ä»¶**: `Dockerfile.frontend`
```dockerfile
# ä¿®å¤å‰:
ENTRYPOINT ["dumb-init", "--", "/custom-entrypoint.sh"]

# ä¿®å¤å:
ENTRYPOINT ["dumb-init", "--"]
CMD ["nginx", "-g", "daemon off;"]
```

#### Gitæäº¤è®°å½•:
- **æäº¤ID**: `48dcb6c`
- **æäº¤ä¿¡æ¯**: "fix(deployment): resolve container startup issues for VPS deployment"
- **ä¿®æ”¹æ–‡ä»¶**: 
  - `backend/docker-start.sh` (2å¤„è¯­æ³•ä¿®å¤)
  - `Dockerfile.frontend` (ç®€åŒ–å…¥å£ç‚¹é…ç½®)

### 3. VPSç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éªŒè¯
**æ—¶é—´æ®µ**: ä¸‹åˆ  
**çŠ¶æ€**: âœ… æˆåŠŸ

#### éƒ¨ç½²è„šæœ¬éªŒè¯:
- **è„šæœ¬ä½ç½®**: `scripts/deploy-production.sh`
- **ç‰ˆæœ¬**: 1.1.0
- **GitHub URL**: https://raw.githubusercontent.com/lonelyrower/SsalgTen/main/scripts/deploy-production.sh
- **çŠ¶æ€**: âœ… å¯æ­£å¸¸è®¿é—®å’Œä½¿ç”¨

#### ç”¨æˆ·éƒ¨ç½²è¿‡ç¨‹:
1. **åˆæ¬¡éƒ¨ç½²é‡åˆ°æ•°æ®åº“è®¤è¯å¤±è´¥**
   - é”™è¯¯: `P1000: Authentication failed against database server`
   - åŸå› : æ—§æ•°æ®å·æ®‹ç•™å¯†ç ä¸åŒ¹é…
   
2. **é—®é¢˜è§£å†³æµç¨‹**:
   ```bash
   cd /opt/ssalgten
   docker-compose -f docker-compose.production.yml down
   docker volume rm ssalgten-postgres-data  # æ¸…ç†æ—§æ•°æ®å·
   docker-compose -f docker-compose.production.yml up -d postgres
   docker-compose -f docker-compose.production.yml run --rm backend npx prisma migrate deploy
   docker-compose -f docker-compose.production.yml run --rm backend npm run db:seed
   docker-compose -f docker-compose.production.yml up -d
   ```

3. **æœ€ç»ˆç»“æœ**: âœ… éƒ¨ç½²æˆåŠŸ
   - æ‰€æœ‰å®¹å™¨å¥åº·è¿è¡Œ
   - æ•°æ®åº“è¿ç§»å®Œæˆ
   - ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºæˆåŠŸ
   - ç³»ç»Ÿé…ç½®åˆå§‹åŒ–å®Œæˆ

### 4. AgentèŠ‚ç‚¹éƒ¨ç½²æŒ‡å¯¼
**æ—¶é—´æ®µ**: ä¸‹åˆ - æ™šä¸Š  
**çŠ¶æ€**: ğŸ”§ éƒ¨åˆ†å®Œæˆï¼Œé…ç½®ä¼˜åŒ–

#### ä¸»æœåŠ¡å™¨Agentéƒ¨ç½²ç­–ç•¥:
ç”¨æˆ·éœ€æ±‚: ä¸»æœåŠ¡å™¨åŒæ—¶ä½œä¸ºAgentèŠ‚ç‚¹è¿›è¡Œç›‘æ§

#### è§£å†³æ–¹æ¡ˆè®¾è®¡:
1. **é¿å…ç«¯å£å†²çª**:
   - ä¸»æœåŠ¡: PostgreSQL(5432), Backend(3001), Frontend(3000)
   - AgentæœåŠ¡: Agent(3002), Redis(6380), PostgreSQL(5433)

2. **Agenté…ç½®æ–‡ä»¶**:
   ```bash
   # /opt/ssalgten/agent/.env
   AGENT_ID=master_server_agent_$(date +%s)
   MASTER_URL=http://localhost:3001
   AGENT_API_KEY=[ä»ä¸»æœåŠ¡å™¨è·å–]
   NODE_NAME=Master-Server-Agent
   NODE_COUNTRY=Japan
   NODE_CITY=Tokyo
   PORT=3002
   ```

3. **ç‹¬ç«‹Docker Composeé…ç½®**:
   - æ–‡ä»¶: `docker-compose.agent.yml`
   - ä»…åŒ…å«AgentæœåŠ¡ï¼Œé¿å…ä¸ä¸»æœåŠ¡å†²çª
   - ä½¿ç”¨ä¸åŒçš„ç«¯å£å’Œå·å

#### é…ç½®çŠ¶æ€:
- âœ… ç«¯å£å†²çªé—®é¢˜è§£å†³æ–¹æ¡ˆ
- âœ… é…ç½®æ–‡ä»¶æ¨¡æ¿æä¾›
- âœ… ç‹¬ç«‹éƒ¨ç½²ç­–ç•¥
- ğŸ”„ ç­‰å¾…ç”¨æˆ·æ˜å¤©åœ¨æ–°VPSä¸Šæµ‹è¯•éªŒè¯

## ğŸ“Š æŠ€æœ¯æˆæœæ€»ç»“

### è§£å†³çš„å…³é”®é—®é¢˜:
1. **å®¹å™¨å¯åŠ¨ç¨³å®šæ€§** - ä¿®å¤JavaScriptè¯­æ³•é”™è¯¯
2. **éƒ¨ç½²è„šæœ¬å¯é æ€§** - éªŒè¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹
3. **æ•°æ®åº“åˆå§‹åŒ–** - è§£å†³å¯†ç ä¸åŒ¹é…é—®é¢˜
4. **Agentæ¶æ„è®¾è®¡** - ä¸»æœåŠ¡å™¨+AgentèŠ‚ç‚¹å…±å­˜æ–¹æ¡ˆ

### æŠ€æœ¯äº®ç‚¹:
- **å®Œæ•´çš„CI/CDæµç¨‹** - ä»å¼€å‘æµ‹è¯•åˆ°ç”Ÿäº§éƒ¨ç½²
- **é”™è¯¯å¤„ç†æœºåˆ¶** - æ•°æ®åº“è®¤è¯å¤±è´¥çš„è‡ªåŠ¨æ¢å¤
- **å¤šèŠ‚ç‚¹æ¶æ„** - æ”¯æŒä¸»æœåŠ¡å™¨ä½œä¸ºç›‘æ§èŠ‚ç‚¹
- **å®¹å™¨åŒ–éƒ¨ç½²** - Dockerå®¹å™¨ç¼–æ’å’Œèµ„æºç®¡ç†

### ä»£ç è´¨é‡:
- **æµ‹è¯•è¦†ç›–**: å…¨åŠŸèƒ½ç«¯åˆ°ç«¯æµ‹è¯•
- **é”™è¯¯ä¿®å¤**: 2ä¸ªå…³é”®è¯­æ³•é”™è¯¯ä¿®å¤
- **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„éƒ¨ç½²å’Œæ•…éšœæ’é™¤æ–‡æ¡£
- **ç‰ˆæœ¬æ§åˆ¶**: è§„èŒƒçš„Gitæäº¤å’Œç‰ˆæœ¬ç®¡ç†

## ğŸš€ æ˜æ—¥è®¡åˆ’

### å¾…éªŒè¯é¡¹ç›®:
1. **æ–°VPSéƒ¨ç½²æµ‹è¯•** - éªŒè¯ä¿®å¤åçš„éƒ¨ç½²è„šæœ¬
2. **AgentèŠ‚ç‚¹è¿æ¥** - æµ‹è¯•ä¸»æœåŠ¡å™¨Agenté…ç½®
3. **å¤šèŠ‚ç‚¹ç›‘æ§** - éªŒè¯èŠ‚ç‚¹æ˜¾ç¤ºå’Œæ•°æ®æ”¶é›†
4. **æ€§èƒ½ä¼˜åŒ–** - æ ¹æ®æµ‹è¯•ç»“æœè¿›è¡Œè°ƒä¼˜

### æŠ€æœ¯æ”¹è¿›æ–¹å‘:
- Agentè‡ªåŠ¨å‘ç°å’Œæ³¨å†Œæœºåˆ¶ä¼˜åŒ–
- å¥åº·æ£€æŸ¥IPv6å…¼å®¹æ€§æ”¹è¿›  
- éƒ¨ç½²è„šæœ¬é”™è¯¯å¤„ç†å¢å¼º
- ç›‘æ§æ•°æ®å¯è§†åŒ–æ”¹è¿›

## ğŸ“ å·¥ä½œç¬”è®°

### é‡è¦å‘ç°:
1. **shellè„šæœ¬ä¸­çš„JavaScriptä»£ç éœ€è¦ç‰¹åˆ«æ³¨æ„ç¾å…ƒç¬¦å·è½¬ä¹‰**
2. **Dockeræ•°æ®å·æŒä¹…åŒ–å¯èƒ½å¯¼è‡´å¯†ç ä¸åŒ¹é…é—®é¢˜**
3. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦è€ƒè™‘ç«¯å£å†²çªå’Œèµ„æºéš”ç¦»**
4. **AgentèŠ‚ç‚¹å¯ä»¥ä¸ä¸»æœåŠ¡å™¨å…±å­˜ï¼Œéœ€è¦é€‚å½“çš„é…ç½®éš”ç¦»**

### æœ€ä½³å®è·µ:
- æ¯æ¬¡é‡å¤§ä¿®æ”¹åè¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
- ç”Ÿäº§éƒ¨ç½²å‰æ¸…ç†æ—§çš„Dockerèµ„æº
- ä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ç®¡ç†ä¸åŒæœåŠ¡
- ä¿æŒè¯¦ç»†çš„å·¥ä½œæ—¥å¿—å’Œæ•…éšœæ’é™¤è®°å½•

---

**å·¥ä½œå®Œæˆæ—¶é—´**: 2025å¹´8æœˆ16æ—¥ 22:45  
**ä¸‹æ¬¡å·¥ä½œè®¡åˆ’**: æ–°VPSéƒ¨ç½²éªŒè¯å’ŒAgentèŠ‚ç‚¹æµ‹è¯•  
**çŠ¶æ€**: é˜¶æ®µæ€§å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·éªŒè¯