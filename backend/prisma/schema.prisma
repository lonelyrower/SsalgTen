// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 节点模型 - 代表每个VPS节点
model Node {
  id          String   @id @default(cuid())
  name        String   // 节点名称，如 "Tokyo Node"
  hostname    String?  // 主机名
  
  // 地理信息
  country     String   // 国家
  city        String   // 城市
  latitude    Float    // 纬度
  longitude   Float    // 经度
  
  // 网络信息
  ipv4        String?  // IPv4地址
  ipv6        String?  // IPv6地址
  
  // ASN信息
  asnNumber   String?  // ASN号码，如 "AS13335"
  asnName     String?  // ASN名称，如 "Cloudflare, Inc."
  asnOrg      String?  // ASN组织
  asnRoute    String?  // ASN路由
  asnType     String?  // ASN类型
  
  // 提供商信息
  provider    String   // 服务提供商，如 "DigitalOcean"
  datacenter  String?  // 数据中心信息
  
  // Agent信息
  agentId     String   @unique // Agent唯一标识
  apiKey      String   // API密钥用于认证
  
  // 状态信息
  status      NodeStatus @default(UNKNOWN)
  lastSeen    DateTime?  // 最后在线时间
  
  // 元数据
  tags        String?    // 标签，JSON字符串
  description String?    // 描述/备注
  
  // 系统信息
  osType      String?    // 操作系统类型
  osVersion   String?    // 操作系统版本
  
  // 时间戳
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // 关系
  diagnosticRecords DiagnosticRecord[]
  heartbeatLogs     HeartbeatLog[]
  eventLogs         EventLog[]
  
  @@map("nodes")
}

// 网络诊断记录
model DiagnosticRecord {
  id        String      @id @default(cuid())
  nodeId    String      // 执行诊断的节点ID
  node      Node        @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // 诊断类型和目标
  type      DiagnosticType  // ping, traceroute, mtr, speedtest
  target    String?         // 诊断目标，speedtest可能为空
  
  // 诊断结果
  success   Boolean         // 是否成功
  result    String          // JSON格式的结果数据
  error     String?         // 错误信息
  
  // 性能指标
  duration  Int?            // 耗时（毫秒）
  
  // 时间戳
  timestamp DateTime        @default(now())
  
  @@map("diagnostic_records")
}

// 心跳日志
model HeartbeatLog {
  id        String   @id @default(cuid())
  nodeId    String   // 节点ID
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  
  // 心跳数据
  status    String   // healthy, degraded, unhealthy
  uptime    Float?   // 运行时间（秒）
  
  // 基础系统指标（保持兼容性）
  cpuUsage  Float?   // CPU使用率
  memoryUsage Float? // 内存使用率
  diskUsage Float?   // 磁盘使用率
  
  // 详细系统信息（JSON格式）
  cpuInfo     Json?    // 详细CPU信息：型号、核数、频率、温度等
  memoryInfo  Json?    // 详细内存信息：类型、速度、可用内存等
  diskInfo    Json?    // 详细磁盘信息：类型、型号、健康状态、温度等
  networkInfo Json?    // 网络流量统计：接收/发送字节数、包数、速度等
  processInfo Json?    // 进程信息：总数、运行数、睡眠数等
  
  // 系统环境信息
  virtualization Json? // 虚拟化信息：类型、提供商等
  services    Json?    // 系统服务状态：docker、nginx等
  loadAverage Json?    // 负载平均值数组
  
  // 网络连接状态（保持兼容性）
  connectivity Json?  // 网络连接测试结果
  
  // 时间戳
  timestamp DateTime @default(now())
  
  @@map("heartbeat_logs")
  @@index([nodeId])
  @@index([timestamp])
}

// 事件日志（节点IP变更、状态变更等）
model EventLog {
  id        String   @id @default(cuid())
  nodeId    String
  node      Node     @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  type      String   // 事件类型：IP_CHANGED、STATUS_CHANGED 等
  message   String?
  details   Json?
  timestamp DateTime @default(now())

  @@map("event_logs")
  @@index([nodeId, timestamp])
}

// 管理员用户
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String   // bcrypt哈希
  
  // 用户信息
  name      String?
  avatar    String?
  
  // 权限
  role      UserRole @default(ADMIN)
  active    Boolean  @default(true)
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  @@map("users")
}

// 系统配置
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique  // 配置键
  value     String   // 配置值（JSON字符串）
  
  // 元数据
  category  String?  // 配置分类
  description String? // 描述
  
  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("settings")
}

// 刷新令牌（用于无感续期与强制注销）
model RefreshToken {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String   @unique
  revoked    Boolean  @default(false)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  ip         String?
  userAgent  String?

  @@map("refresh_tokens")
  @@index([userId])
  @@index([expiresAt])
}

// 访问者信息记录
model VisitorLog {
  id          String   @id @default(cuid())
  
  // 基础信息
  ip          String   // 访问者IP
  userAgent   String   // 用户代理
  
  // 地理位置信息
  city        String?  // 城市
  region      String?  // 地区/省份
  country     String?  // 国家
  latitude    Float?   // 纬度
  longitude   Float?   // 经度
  timezone    String?  // 时区
  
  // ASN信息
  asnNumber   String?  // ASN号码
  asnName     String?  // ASN名称
  asnOrg      String?  // ASN组织
  
  // 运营商信息
  company     String?  // 运营商名称
  
  // 访问信息
  endpoint    String?  // 访问的端点
  method      String?  // HTTP方法
  referer     String?  // 来源
  
  // 诊断相关
  nodeId      String?  // 关联的节点ID（如果是通过节点访问）
  
  // 时间戳
  createdAt   DateTime @default(now())
  
  @@map("visitor_logs")
  @@index([ip])
  @@index([createdAt])
}

// 枚举类型
enum NodeStatus {
  ONLINE
  OFFLINE
  UNKNOWN
  MAINTENANCE
}

enum DiagnosticType {
  PING
  TRACEROUTE
  MTR
  SPEEDTEST
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}
